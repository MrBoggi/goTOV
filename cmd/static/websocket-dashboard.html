<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üç∫ goT√òV ‚Äì UA Live Dashboard</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #111;
      color: #eee;
      padding: 20px;
    }
    h1 {
      color: #ffa500;
      margin-bottom: 10px;
    }
    h2 {
      color: #ffa500;
      margin-top: 30px;
      border-bottom: 1px solid #333;
      padding-bottom: 4px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 950px;
      background: #222;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 5px;
    }
    th, td {
      padding: 6px 10px;
      border-bottom: 1px solid #333;
      text-align: left;
    }
    th {
      background: #333;
      color: #ffa500;
    }
    .status {
      margin: 10px 0;
      font-weight: bold;
    }
    .ok { color: #4caf50; }
    .err { color: #f44336; }

    /* Kontrollpanel */
    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
      max-width: 950px;
    }
    button.toggle {
      background: #333;
      color: #fff;
      padding: 10px;
      border: 1px solid #555;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.25s ease;
    }
    button.toggle.on { background: #4caf50; }
    button.toggle.off { background: #f44336; }
  </style>
</head>
<body>
  <h1>üç∫ goT√òV ‚Äì Live UA Monitor</h1>
  <div id="status" class="status">Connecting...</div>

  <!-- Temperaturer -->
  <h2>üå°Ô∏è Temperatur- og sensorinnganger</h2>
  <table id="tempTable">
    <thead>
      <tr><th>Sensor</th><th>Verdi</th><th>Type</th><th>Tid</th></tr>
    </thead>
    <tbody id="tempBody"></tbody>
  </table>

  <!-- Flow -->
  <h2>üíß Flowm√•lere</h2>
  <table id="flowTable">
    <thead>
      <tr><th>Sensor</th><th>Verdi</th><th>Type</th><th>Tid</th></tr>
    </thead>
    <tbody id="flowBody"></tbody>
  </table>

  <!-- Pumper og ventiler -->
  <h2>‚öôÔ∏è Manuell kontroll</h2>
  <div class="control-grid" id="controls">
    <button class="toggle" data-tag="MAIN.fbUA.pumpeHLT">HLT Pumpe</button>
    <button class="toggle" data-tag="MAIN.fbUA.pumpeWort">V√∏rterpumpe</button>
    <button class="toggle" data-tag="MAIN.fbUA.V1_VannInn">V1 Vann inn</button>
    <button class="toggle" data-tag="MAIN.fbUA.V2_HLT_TilMLT">V2 HLT ‚Üí MLT</button>
    <button class="toggle" data-tag="MAIN.fbUA.V3_MLT_TilBK">V3 MLT ‚Üí BK</button>
    <button class="toggle" data-tag="MAIN.fbUA.V4_BK_TilHX">V4 BK ‚Üí HX</button>
    <button class="toggle" data-tag="MAIN.fbUA.V5_HX_TilDrain">V5 HX ‚Üí Avl√∏p</button>
    <button class="toggle" data-tag="MAIN.fbUA.V6_HX_TilFerment">V6 HX ‚Üí Ferment</button>
    <button class="toggle" data-tag="MAIN.fbUA.V7_SpargeWater">V7 Spargevann</button>
    <button class="toggle" data-tag="MAIN.fbUA.V8_ChillerIn">V8 Chiller In</button>
    <button class="toggle" data-tag="MAIN.fbUA.V9_ChillerOut">V9 Chiller Out</button>
  </div>

  <!-- Gj√¶ring -->
  <h2>üç∂ Gj√¶rings- og kj√∏lesystem</h2>
  <div class="control-grid">
    <button class="toggle" data-tag="MAIN.fbUA.fermenter1Kjoleventil">Fermenter1 kj√∏leventil (√Öpen/Stengt)</button>
    <button class="toggle" data-tag="MAIN.fbUA.fermenter2Kjoleventil">Fermenter2 kj√∏leventil (√Öpen/Stengt)</button>
    <button class="toggle" data-tag="MAIN.fbUA.fermenter1Varmekappe">Fermenter1 varmekappe (Av/P√•)</button>
    <button class="toggle" data-tag="MAIN.fbUA.fermenter2Varmekappe">Fermenter2 varmekappe (Av/P√•)</button>
    <button class="toggle" data-tag="MAIN.fbUA.glykolkjolerPumpe">Glykolkj√∏lerpumpe (Av/P√•)</button>
  </div>

  <!-- ============================== -->
  <!-- üç∫ BREWFATHER IMPORT SECTION -->
  <!-- ============================== -->
  <h2>üì¶ Brewfather ‚Äì Import√©r Batch</h2>

  <div style="margin-top:10px; max-width:800px; background:#1b1b1b; padding:15px; border-radius:10px;">
    
    <!-- Fetch batches -->
    <button id="btnFetchBatches" style="padding:8px 15px; margin-bottom:10px;">
      üîÑ Hent batcher fra Brewfather
    </button>

    <div id="batchListContainer" style="display:none; margin-top:10px;">
      <label for="batchSelect">Velg batch:</label><br />
      <select id="batchSelect" style="width:100%; padding:6px; margin-top:5px;"></select>
    </div>

    <!-- Batch details -->
    <div id="batchDetails" style="display:none; margin-top:20px;">
      <h3 style="color:#ffa500;">üõ† Rediger fermenteringsplan</h3>
      <table id="stepsTable" style="margin-top:10px;">
        <thead>
          <tr>
            <th>Steg</th>
            <th>Temp (¬∞C)</th>
            <th>Timer</th>
            <th>Type</th>
            <th>Beskrivelse</th>
          </tr>
        </thead>
        <tbody id="stepsBody"></tbody>
      </table>
    </div>

    <!-- Start fermentation -->
    <div id="startFermentation" style="display:none; margin-top:20px;">
      <h3 style="color:#ffa500;">üöÄ Start gj√¶ring</h3>

      <label>Tank:</label><br />
      <select id="tankSelect" style="width:200px; padding:6px; margin-bottom:10px;">
        <option value="1">Fermenter 1</option>
        <option value="2">Fermenter 2</option>
      </select><br /><br />

      <label>Start fra steg:</label><br />
      <select id="stepSelect" style="width:200px; padding:6px;"></select>

      <br /><br />
      <button id="btnStartFermentation" style="padding:10px 20px; font-weight:bold;">
        üç∫ Start fermentering
      </button>
    </div>
  </div>




  <script>
    const statusEl = document.getElementById("status");
    const tags = {};
    const toggleButtons = document.querySelectorAll("button.toggle");

    function setButtonState(tag, value) {
      const normalized = tag.replace(/^ns=\\d+;s=/, "");
      const btn = document.querySelector(`button[data-tag="${normalized}"]`);
      if (!btn) return;

      const isOn = value === true || value === 1 || value === "true";
      btn.classList.toggle("on", isOn);
      btn.classList.toggle("off", !isOn);

      const base = btn.dataset.label || btn.textContent.replace(/\\(.*\\)/, "").trim();
      btn.dataset.label = base;
      if (base.toLowerCase().includes("ventil"))
        btn.textContent = `${base} (${isOn ? "√Öpen" : "Stengt"})`;
      else
        btn.textContent = `${base} (${isOn ? "P√•" : "Av"})`;
    }

    // Lagre brukerens valg i minnet (og evt. i localStorage senere)
    const scalePrefs = {};

    function renderTable() {
      const tempBody = document.getElementById("tempBody");
      const flowBody = document.getElementById("flowBody");
      tempBody.innerHTML = "";
      flowBody.innerHTML = "";

      // Legg til header med "Skal√®r"
      if (!document.querySelector("#tempTable thead th.scale-header")) {
        document.querySelector("#tempTable thead tr").insertAdjacentHTML(
          "beforeend",
          `<th class="scale-header" style="text-align:center;">Skal√®r</th>`
        );
      }
      if (!document.querySelector("#flowTable thead th.scale-header")) {
        document.querySelector("#flowTable thead tr").insertAdjacentHTML(
          "beforeend",
          `<th class="scale-header" style="text-align:center;">Skal√®r</th>`
        );
      }

      // Sorter etter siste oppdatering
      const sorted = Object.entries(tags).sort(([, a], [, b]) => b.ts_ms - a.ts_ms);

      for (const [tag, d] of sorted) {
        const display = d.display_name || tag;
        const t = new Date(d.ts_ms).toLocaleTimeString();
        const scaledId = `scale_${tag.replace(/[^\w]/g, "_")}`;
        const isScaled = scalePrefs[tag] === true;
        const shownValue = isScaled && !isNaN(d.value)
          ? (d.value / 10).toFixed(1)
          : d.value;

        const row = `
          <tr title="${tag}">
            <td>${display}</td>
            <td id="val_${scaledId}">${shownValue}</td>
            <td>${d.value_type}</td>
            <td>${t}</td>
            <td style="text-align:center;">
              <input type="checkbox" id="${scaledId}" ${
                isScaled ? "checked" : ""
              } onchange="toggleScale('${tag}', this.checked)">
            </td>
          </tr>`;

        if (
            d.value_type.toLowerCase().includes("float") &&
            !tag.toLowerCase().includes("flow")
        ) {
            tempBody.insertAdjacentHTML("beforeend", row);
        }
        else if (tag.toLowerCase().includes("flow")) {
            flowBody.insertAdjacentHTML("beforeend", row);
        }    
      }
    }

    // Toggle skalering og husk valget
    function toggleScale(tag, enabled) {
      scalePrefs[tag] = enabled;
      const scaledId = `scale_${tag.replace(/[^\w]/g, "_")}`;
      const valEl = document.getElementById(`val_${scaledId}`);
      const rawValue = tags[tag]?.value;
      if (valEl && !isNaN(rawValue)) {
        valEl.textContent = enabled ? (rawValue / 10).toFixed(1) : rawValue;
      }
    }

    function connectWS() {
      const ws = new WebSocket("ws://localhost:8080/api/stream/tags");
      ws.onopen = () => { statusEl.textContent = "‚úÖ Connected"; statusEl.className = "status ok"; };
      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        tags[msg.tag] = msg;
        renderTable();
        setButtonState(msg.tag, msg.value);
      };
      console.log("WS:", msg.tag, msg.value);
      ws.onclose = () => {
        statusEl.textContent = "‚ùå Disconnected, retrying...";
        statusEl.className = "status err";
        setTimeout(connectWS, 3000);
      };
    }

    toggleButtons.forEach(btn => {
      btn.dataset.label = btn.textContent.replace(/\\(.*\\)/, "").trim();
      btn.classList.add("off");
      btn.addEventListener("click", async () => {
        const tag = btn.dataset.tag;
        const isOn = btn.classList.contains("on");
        const newValue = !isOn;
        setButtonState(tag, newValue);
        try {
          await fetch("http://localhost:8080/api/write", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tag, value: newValue }),
          });
        } catch (e) { console.error("Write failed", e); }
      });
    });

    connectWS();
    // ‚Ä¶ resten av WS-koden over er uendret ‚Ä¶

    // ---------------------------
    // BREWFATHER IMPORT LOGIC (FIXED)
    // ---------------------------

    const btnFetchBatches = document.getElementById("btnFetchBatches");
    const batchListContainer = document.getElementById("batchListContainer");
    const batchSelect = document.getElementById("batchSelect");
    const batchDetails = document.getElementById("batchDetails");
    const stepsBody = document.getElementById("stepsBody");
    const startSection = document.getElementById("startFermentation");
    const tankSelect = document.getElementById("tankSelect");
    const stepSelect = document.getElementById("stepSelect");

    let currentSteps = [];
    let selectedBatch = null;

    // -------- 1) Fetch Brewfather Batches ----------
    btnFetchBatches.onclick = async () => {
      const res = await fetch("http://localhost:8080/api/brewfather/batches");
      const batches = await res.json();

      batchSelect.innerHTML = batches
        .map(b => `<option value="${b._id}">${b.name}</option>`)
        .join("");

      batchListContainer.style.display = "block";
    };

    // -------- 2) Select batch and fetch full details --------
    batchSelect.onchange = async () => {
      const id = batchSelect.value;
      const res = await fetch(`http://localhost:8080/api/brewfather/batch/${id}`);
      const data = await res.json();

      selectedBatch = data;

      // -------- Convert Brewfather data to our step format --------
      currentSteps = convertBrewfatherToSteps(data);

      renderStepsTable();
      batchDetails.style.display = "block";

      // Populate "start from step"
      stepSelect.innerHTML = currentSteps
        .map((s, i) => `<option value="${i}">Steg ${s.step_number}</option>`)
        .join("");

      startSection.style.display = "block";
    };

    // -------- Conversion function --------
    function convertBrewfatherToSteps(data) {
      const steps = [];

      if (!data.fermentation || !data.fermentation.tempProfile) {
        alert("Batch mangler tempProfile ‚Äì ikke st√∏ttet.");
        return [];
      }

      data.fermentation.tempProfile.forEach((p, i) => {
        steps.push({
          step_number: i + 1,
          temperature: Number(p.temp) || 20,
          duration_hours: Number(p.time || p.duration) || 24,
          type: "fermentation",
          description: p.description || `Steg ${i + 1}`
        });
      });

      return steps;
    }

    // -------- Render editable step table --------
    function renderStepsTable() {
      stepsBody.innerHTML = currentSteps
        .map((s, i) => `
          <tr>
            <td>${s.step_number}</td>
            <td><input type="number" value="${s.temperature}"
                onchange="updateStep(${i}, 'temperature', this.value)"></td>
            <td><input type="number" value="${s.duration_hours}"
                onchange="updateStep(${i}, 'duration_hours', this.value)"></td>
            <td><input type="text" value="${s.type}"
                onchange="updateStep(${i}, 'type', this.value)"></td>
            <td><input type="text" value="${s.description}"
                onchange="updateStep(${i}, 'description', this.value)"></td>
          </tr>
        `)
        .join("");
    }

    window.updateStep = (i, field, value) => {
      currentSteps[i][field] = value;
    };

    // -------- 4) Start fermentation --------
    document.getElementById("btnStartFermentation").onclick = async () => {
      const payload = {
        batch_id: selectedBatch._id,
        tank_no: Number(tankSelect.value),
        start_step: Number(stepSelect.value),
        steps: currentSteps
      };

      const res = await fetch("http://localhost:8080/api/fermentation/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const msg = await res.text();
      alert("Fermentering startet: " + msg);
    };
  </script>
</body>
</html>
